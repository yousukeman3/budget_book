# 🏗️ アーキテクチャ設計（budget_book）

---

## 使用技術スタック

- **Next.js (App Router, Server Action)**
- **Node.js (Backend API)**
- **PostgreSQL (DB)**
- **Prisma (ORM)**
- **Zod (型バリデーション)**
- **React / TailwindCSS (UI)**
- **TypeScript（全体の型安全）**

---

## 全体構成

- **フロントエンド**：Next.js App Router + React
- **バックエンド**：APIルート / Server Actions によるデータ操作
- **DB接続**：Prisma + PostgreSQL
- **バリデーション**：Zodスキーマを `shared/zod/` に集約して共通化
- **UIレイヤー**：Atomic Design 寄りのComponent設計

---

## ディレクトリ構成（予定）

```text
src/
├── app/            # Next.js pages / routes
├── components/     # 共通UI部品
├── core/           # ドメインごとのロジック（entry, debt, method, reportなど）
├── shared/zod/     # Zodスキーマ（ドメインごとに分離）
├── lib/            # 汎用ライブラリ
└── db/             # Prismaスキーマ、DBアクセス
```

---

## バリデーション戦略（Zod）

- ドメインごとに Zod スキーマを分離
  - 例：`shared/zod/entrySchema.ts`, `shared/zod/debtSchema.ts`
- スキーマは **UI側のForm + API側の検証で共通利用**
- DTO変換や整形処理は `core/entry/usecase.ts` などで行う

---

## 🖼️ リソース保存（画像・証憑）

- `evidenceNote` に対応する証憑画像などのファイルは、以下のパスに保存される：

```path
public/storage/receipt/
```

- URLとしては `https://budget-book.yousukeman3.uk/storage/receipt/<filename>` 形式でアクセス可能。

- URIが指定された場合、**必ずこの保存領域内のファイルである必要がある**（ドメインルールに準拠）。

- クラウド連携ではなくローカル運用前提（自宅PCサーバー上）。

- Cloudflare Tunnel では `/storage/*` パスを許可対象とすることで、外部アクセスに対応。

> ⚠️ 将来的にリソースの削除制御・認可管理が必要になる可能性あり。

---

## 通知機能について（現状）

- 通知（Web Push / Google連携など）は、**現時点ではユースケースに含まれていない**
- 今後、AIコンシェルジュや提案機能のトリガーとして実装可能性あり
- 必要に応じて NotificationRule ドメインを再活性化する方針

---

## 🐳 開発用Docker構成（WSL推奨）

新PCへの移行や再構築を容易にするため、Docker + Compose による開発用構成を提供する。

- **OS**: WSL2（Ubuntu 20.04 以上）を推奨
- **サービス構成**:
  - app: Next.js + Node.js 18
  - db: PostgreSQL 15
- **ボリューム永続化**によりDBデータは維持
- `.env.development` で環境変数を管理

通常は `docker compose up` だけで立ち上げ可能。

---

## 🚀 本番環境構成（自宅PCサーバー + Cloudflare Tunnel）

本番環境は自宅PC上でDockerコンテナにより運用する。  
外部公開は Cloudflare Tunnel + Zero Trust により安全に構成。

### インフラ構成

- **OS**：Ubuntu 22.04 LTS（予定）
- **アプリケーション**：
  - app（Next.js / Node.js）: `Dockerfile` によりビルド
  - db（PostgreSQL）: データボリュームを持つ

### ネットワーク構成

- **外部公開**：
  - `cloudflared` による Tunnel 接続
  - `https://budget-book.yousukeman3.uk` → localhost:3000 にマッピング
- **セキュリティ制御**：
  - Cloudflare Zero Trust による認証（Google OAuth / OTPなど）
  - ドメイン単位でルールを設定（管理者のみアクセス可）

> 📌 この構成により、NATやポート開放なしで安全に外部公開が可能。

---

## 将来的な拡張構想（構想フェーズ）

以下の機能は現在は未実装だが、中核構想として設計上想定されている：

- **LLMとの連携**
  - 月次レポートの要約
  - 支出傾向のアドバイス生成
- **Live2DによるコンシェルジュUI**
  - 会話型インタフェース
  - 音声入力対応
  - 自律的なリマインド・フィードバック
