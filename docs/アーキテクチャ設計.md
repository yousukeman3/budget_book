
# 🏛️ アーキテクチャ設計（budget_book）

## 🎯 目的

本システムは、収支・貸借・支払い方法を中心に、個人の金銭管理を支援する。  
将来的にはLLM・Live2Dアバターによる生活支援アプリへと統合されるため、拡張性・統合性・UXを重視した設計とする。

---

## 🧠 基本思想

- **ドメイン駆動（DDD）+ クリーンアーキテクチャ志向**
- **技術より“意味と責務”を優先**
- **ユースケースをアプリの“脳”とみなし、ドメインとインフラを仲介する**

---

## 🗂️ ディレクトリ構成

```text
src/
└── modules/
    ├── entry/
    │   ├── domain/
    │   ├── application/
    │   │   ├── usecases/
    │   │   └── queries/
    │   └── infrastructure/
    │       └── prisma/
    ├── debt/
    │   └── ...
    ├── method/
    │   └── ...
    └── queries/           ← 横断的Queryを置く場合
shared/
    ├── zod/               ← バリデーションスキーマ
    ├── errors/            ← 共通エラー
    └── types/             ← 型定義
ui/
    └── nextjs/            ← Next.jsベースのUIアプリ
api/
    └── handlers/          ← REST/HTTP APIハンドラ（必要に応じて）
```

---

## 🧱 レイヤーと責務

| レイヤー | 主な責務 |
|----------|-----------|
| **UI層** | Server Action / API → ユースケース呼び出し |
| **Application層** | ユースケース（registerEntry等）、フロー制御 |
| **Domain層** | 意味・ルール・不変条件の定義（Entry, Debt, etc） |
| **Infrastructure層** | DBアクセス、通知、外部連携の実装 |
| **Query Service** | 集計や表示専用の高速化された読み取り処理 |

---

## 🔌 ポートとアダプタ

- アプリケーション層が **interface（ポート）** を定義し、
- インフラ層が **実装（アダプタ）** を提供する

例：

```ts
// ポート定義
interface EntryRepository {
  save(entry: Entry): Promise<void>;
}

// アダプタ実装
const EntryRepositoryImpl: EntryRepository = { ... }
```

---

## 📊 特別な扱い：Query

- 表示・分析・レポートなど、“見せること”が目的の処理はユースケースから分離
- ドメインルールを気にせず、集計・加工・最適化に特化できる
- `application/queries/` or `modules/queries/` に配置

---

## ⚠️ エラーハンドリング

- Zod（形式） → Domain（不変条件）→ UseCase（流れ・状態）という3段構造
- 各レイヤーで責務に応じた例外を投げる
- 専用Error型によるハンドリング（予定）

---

## 🛠️ データ永続化（マイグレーション）

- **インフラ層の責任**として Prisma を用いる
- `schema.prisma`は `infrastructure/prisma/` に配置
- マイグレーションは基本共有、必要であればモジュール単位で分離可

---

## 🔁 依存関係の原則（依存性逆転）

```text
[ UI / API ]
    ↓
[ UseCase ] ← ポートで依存を受ける
    ↓
[ Domain ]
    ↑
[ Infrastructure ] ← アダプタ実装
```

- 中心は **ドメイン**、そこに向かって依存する構造

---

## 🌱 今後の想定拡張

- 通知インフラ（LINE, Googleカレンダーなど）
- スケジューラとの連携
- アバターUIによるコンシェルジュ機能
- LLM APIの接続と自然言語による操作支援
