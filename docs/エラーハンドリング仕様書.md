# エラーハンドリング仕様書

## 目的

- 発生しうるエラーを事前に整理し、エラー発生時の挙動や対処を明確にする
- 開発や運用時のトラブルシューティングを容易にする

---

## エラーID構成

```text
E [エラーレベル][機能分類][連番]
```

### エラーレベル

| 数字 | レベル | 説明 |
|------|-------|------|
| 1 | ユーザー入力エラー | ユーザーが修正可能な入力ミスや不正値 |
| 2 | システムエラー | 設定不備、外部リソース読み込み失敗等 |
| 9 | 致命的エラー | アプリケーションの動作が停止する深刻な問題 |

### 機能分類

| 番号 | 機能 |
|------|------|
| 01 | 収支記録（Entry）|
| 02 | 貸借管理（Debt）|
| 03 | 設定・環境 |
| 04 | 通知 |
| 05 | UI関連 |
| 99 | 共通・その他 |

---

## エラーケース一覧

### ユーザー入力エラー（E1xxx）

| ID | 発生箇所 | メッセージ | 発生条件 | 通知・処理方法 |
|----|----------|-----------|----------|-------------|
| E1011 | Entry登録時 | 日付が未入力です。| 日付未入力 | 即時表示 |
| E1012 | Entry登録時 | 日付が未来の日付です。| 未来日入力 | 即時表示 |
| E1013 | Entry登録時 | 金額が不正です。| 負数や非数値 | 即時表示 |
| E1014 | Entry登録時 | 収支タイプが不正です。| 不正な収支タイプ | 即時表示 |
| E1015 | Entry登録時 | 取引ID形式が不正です。| 正規表現に合致しない | 即時表示 |
| E1016 | Entry登録時 | カテゴリが不正です。| 収支タイプとカテゴリ不一致 | 即時表示 |
| E1017 | Entry登録時 | 支払方法が不正です。| 許可されていない方法 | 即時表示 |
| E1021 | Debt登録時 | 返済方式未設定です。 | 返済方式未入力 | 即時表示 |
| E1022 | Debt登録時 | 返済周期が不正です。 | 許可されていない周期 | 即時表示 |
| E1023 | Debt登録時 | 金額が不正です。 | 負数や非数値 | 即時表示 |

### システムエラー（E2xxx）

| ID | 発生箇所 | メッセージ | 発生条件 | 通知・処理方法 |
|----|----------|-----------|----------|-------------|
| E2031 | 設定シート読込 | カテゴリ設定を読み込めませんでした。| シート削除・破損 | 管理者通知・ログ記録 |
| E2032 | 設定シート読込 | 支払方法設定を読み込めませんでした。| シート削除・破損 | 管理者通知・ログ記録 |
| E2033 | 設定シート読込 | 通知設定を読み込めませんでした。| シート削除・破損 | 管理者通知・ログ記録 |
| E2041 | 通知処理 | 通知送信に失敗しました。| 外部API障害 | 管理者通知・ログ記録 |

### 致命的エラー（E9xxx）

| ID | 発生箇所 | メッセージ | 発生条件 | 通知・処理方法 |
|----|----------|-----------|----------|-------------|
| E9011 | 共通処理 | 予期せぬエラーが発生しました。 | 例外キャッチ | 管理者通知・即時調査 |
| E9012 | 収支記録 | 収支シートが存在しません。 | シート削除 | 管理者通知・即時調査 |
| E9013 | 貸借管理 | 貸借管理シートが存在しません。 | シート削除 | 管理者通知・即時調査 |

---

## エラー通知方針

- **ユーザー入力エラー（E1xxx）**
  - ユーザーに即時表示（シートやUI上）

- **システムエラー（E2xxx）・致命的エラー（E9xxx）**
  - 管理者にメール通知
  - ログに詳細を記録

---

## エラー処理の実装方針

### バリデーションエラー（ユーザー入力系）

- 専用の `ValidationError` 型を使用し、エラーをリスト形式で返却する

```typescript
export type ValidationError = {
  field: string;
  message: string;
  errorId: string;  // E1xxx
};
```

### システムエラー・致命的エラー

- 共通の `SystemError` 型を定義し、例外を投げて処理する

```typescript
export type SystemError = {
  errorId: string;  // E2xxxまたはE9xxx
  message: string;
  detail?: any;
};
```

- 共通エラー処理関数を用意し、ログ記録と管理者通知を一元的に処理する

```typescript
function handleSystemError(errorId: string, message: string, detail?: any): SystemError {
  Logger.log(`Error [${errorId}]: ${message} Detail: ${JSON.stringify(detail)}`);
  notifyAdmin(errorId, message, detail);
  return { errorId, message, detail };
}
```

---

## 今後の運用方針

- 新規エラーケースが発生した場合、エラーケース一覧に随時追加する
- エラーID体系は変更しないこと（既存IDとの一貫性を保つ）
